<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡易ダクト2Dアプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            position: fixed;
            inset: 0;
        }
        @media (max-width: 767px) {
            #palette {
                max-height: 45vh;
                flex-shrink: 0;
            }
        }
        canvas { cursor: grab; touch-action: none; width: 100%; height: 100%; display: block; }
        canvas.grabbing { cursor: grabbing; }
        .palette-item { transition: all 0.2s ease-in-out; }
        .palette-item:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; }
            canvas { width: 100vw; height: 100vh; }
        }
        #context-menu.hidden { display: none; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col md:flex-row">
    <!-- 部品パレット (サイドバー) -->
    <aside id="palette" class="w-full md:w-64 bg-white shadow-lg p-4 overflow-y-auto order-first md:order-last">
        <div class="mb-6">
            <div class="space-y-2">
                 <div>
                    <input type="text" id="system-name" value="SA-1" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500" placeholder="系統名">
                </div>
                <div>
                    <input type="number" id="custom-diameter" value="100" step="25" min="25" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500" placeholder="直径 (mm)">
                </div>
                <button id="add-custom-straight" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors">
                    直管を追加
                </button>
            </div>
        </div>
        <div class="mb-6 border-t pt-4">
             <button id="manage-fittings-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition-colors">継手管理</button>
        </div>
        <div id="palette-items" class="grid grid-cols-2 gap-4">
            <!-- パレットアイテムはJSで動的に生成 -->
        </div>
    </aside>

    <!-- メインコンテンツ -->
    <main class="flex-1 flex flex-col relative print-area">
        <!-- ツールバー -->
        <header class="bg-white/80 backdrop-blur-sm shadow-md p-2 flex items-center justify-between z-10">
            <div class="flex items-center flex-wrap gap-x-1 md:gap-x-2 gap-y-1">
                <button id="toggle-palette-btn" title="パレットを開閉" class="p-2 rounded-md hover:bg-gray-200 md:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/></svg>
                </button>
                 <button id="undo-btn" title="元に戻す" class="p-2 rounded-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9h12a5 5 0 0 1 5 5v0a5 5 0 0 1-5 5H7.5"/><path d="m6 12 3-3-3-3"/></svg>
                </button>
                <button id="redo-btn" title="やり直す" class="p-2 rounded-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 9H9a5 5 0 0 0-5 5v0a5 5 0 0 0 5 5h7.5"/><path d="m18 12-3-3 3-3"/></svg>
                </button>
                <div class="h-6 w-px bg-gray-300"></div>
                <button id="measure-tool" title="2点間計測" class="p-2 rounded-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v16H6.5a2.5 2.5 0 0 1 0-5H20"/><line x1="4" x2="8" y1="15" y2="15"/></svg>
                </button>
                <button id="zoom-in" title="ズームイン" class="p-2 rounded-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></svg>
                </button>
                <button id="zoom-out" title="ズームアウト" class="p-2 rounded-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></svg>
                </button>
                <button id="reset-view" title="ビューをリセット" class="p-2 rounded-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
                </button>
                <button id="clear-canvas" title="キャンバスをクリア" class="p-2 rounded-md hover:bg-gray-200 text-red-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
                <button id="screenshot-btn" title="スクリーンショット" class="p-2 rounded-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                </button>
                 <button id="share-btn" title="共有" class="p-2 rounded-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" x2="12" y1="2" y2="15"></line></svg>
                </button>
                <button id="print-btn" title="印刷" class="p-2 rounded-md hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg></button>
            </div>
        </header>

        <!-- キャンバスエリア -->
        <div class="flex-1 bg-gray-200 relative overflow-hidden">
            <canvas id="canvas"></canvas>
            <div id="info-overlay" class="absolute top-2 left-2 bg-white/70 backdrop-blur-sm p-2 rounded-md text-sm pointer-events-none"></div>
            <!-- コンテキストメニュー -->
            <div id="context-menu" class="absolute bg-white shadow-lg rounded-md p-1 flex items-center space-x-1 z-20 hidden">
                <button id="rotate-btn" title="回転 (R)" class="p-2 rounded-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M2 11.5A10 10 0 0 1 12 2a10 10 0 0 1 10 9.5"/><path d="M22 12.5a10 10 0 0 1-10 9.5a10 10 0 0 1-10-9.5"/></svg>
                </button>
                <button id="flip-btn" title="反転" class="p-2 rounded-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 12h18"/><path d="m7 22-4-4 4-4"/><path d="M21 12H3"/></svg>
                </button>
                <button id="delete-btn" title="削除 (Delete)" class="p-2 rounded-md hover:bg-gray-200 text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
                <button id="disconnect-btn" title="接合を解除" class="p-2 rounded-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>
                </button>
            </div>
        </div>
        <div id="notification" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none z-30">
        </div>
    </main>
    
    <!-- 継手管理モーダル -->
    <div id="fittings-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold">継手管理</h2>
                <button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-200">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto pr-2">
                <div id="fittings-editor">
                    <!-- JSで継手エディタを生成 -->
                </div>
            </div>
            <div class="mt-4 border-t pt-4 flex justify-end">
                <button id="save-fittings-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-indigo-700 transition-colors">保存</button>
            </div>
        </div>
    </div>

    <!-- 汎用モーダル (確認/入力) -->
    <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h2 id="modal-title" class="text-xl font-bold mb-4"></h2>
            <div id="modal-body"></div>
            <div id="modal-footer" class="mt-4 flex justify-end space-x-2"></div>
        </div>
    </div>
    <script src="/duct-app-script.js"></script>
</body>
</html>